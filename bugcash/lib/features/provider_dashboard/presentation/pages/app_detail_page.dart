import 'package:flutter/material.dart';
import 'package:flutter_screenutil/flutter_screenutil.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import '../../../../core/utils/logger.dart';
import 'app_management_page.dart';

class AppDetailPage extends ConsumerStatefulWidget {
  final ProviderAppModel app;

  const AppDetailPage({
    super.key,
    required this.app,
  });

  @override
  ConsumerState<AppDetailPage> createState() => _AppDetailPageState();
}

class _AppDetailPageState extends ConsumerState<AppDetailPage> {
  late TextEditingController _appNameController;
  late TextEditingController _appUrlController;
  late TextEditingController _descriptionController;
  late TextEditingController _announcementController;
  late TextEditingController _priceController;
  late TextEditingController _requirementsController;

  late String _selectedCategory;
  bool _hasAnnouncement = false;
  bool _isActive = true;
  bool _isLoading = false;

  final List<String> _categories = [
    'Productivity',
    'Social',
    'Entertainment',
    'Education',
    'Health & Fitness',
    'Finance',
    'Shopping',
    'Travel',
    'Food & Drink',
    'Games',
    'Other',
  ];

  @override
  void initState() {
    super.initState();
    _initializeControllers();
  }

  void _initializeControllers() {
    _appNameController = TextEditingController(text: widget.app.appName);
    _appUrlController = TextEditingController(text: widget.app.appUrl);
    _descriptionController = TextEditingController(text: widget.app.description);
    _selectedCategory = widget.app.category;

    // Í∏∞Ï°¥ Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ÏóêÏÑú Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
    final metadata = widget.app.metadata;
    _hasAnnouncement = metadata['hasAnnouncement'] ?? false;
    _isActive = metadata['isActive'] ?? true;
    _announcementController = TextEditingController(text: metadata['announcement'] ?? '');
    _priceController = TextEditingController(text: (metadata['price'] ?? 0).toString());
    _requirementsController = TextEditingController(text: metadata['requirements'] ?? '');
  }

  @override
  void dispose() {
    _appNameController.dispose();
    _appUrlController.dispose();
    _descriptionController.dispose();
    _announcementController.dispose();
    _priceController.dispose();
    _requirementsController.dispose();
    super.dispose();
  }

  Future<void> _saveChanges() async {
    if (_appNameController.text.isEmpty ||
        _descriptionController.text.isEmpty ||
        _priceController.text.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('ÌïÑÏàò ÌïÑÎìúÎ•º Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî')),
      );
      return;
    }

    setState(() {
      _isLoading = true;
    });

    try {
      // Í∞ÄÍ≤© Í≤ÄÏ¶ù
      final price = double.tryParse(_priceController.text);
      if (price == null || price < 0) {
        throw Exception('Ïò¨Î∞îÎ•∏ Í∞ÄÍ≤©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
      }

      final updatedData = {
        'appName': _appNameController.text,
        'appUrl': _appUrlController.text,
        'description': _descriptionController.text,
        'category': _selectedCategory,
        'updatedAt': FieldValue.serverTimestamp(),
        'metadata': {
          ...widget.app.metadata,
          'hasAnnouncement': _hasAnnouncement,
          'announcement': _hasAnnouncement ? _announcementController.text : '',
          'price': price,
          'requirements': _requirementsController.text,
          'isActive': _isActive,
        },
      };

      await FirebaseFirestore.instance
          .collection('provider_apps')
          .doc(widget.app.id)
          .update(updatedData);

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Ïï± Ï†ïÎ≥¥Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§')),
        );
        Navigator.of(context).pop(true); // Î≥ÄÍ≤ΩÏÇ¨Ìï≠Ïù¥ ÏûàÏùåÏùÑ ÏïåÎ¶º
      }
    } catch (e) {
      AppLogger.error('Failed to update app', e.toString());
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: ${e.toString()}')),
        );
      }
    } finally {
      if (mounted) {
        setState(() {
          _isLoading = false;
        });
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        backgroundColor: Colors.indigo[900],
        foregroundColor: Colors.white,
        title: Text(
          'Ïï± ÏÉÅÏÑ∏ Í¥ÄÎ¶¨',
          style: TextStyle(
            fontWeight: FontWeight.w600,
            fontSize: 18.sp,
          ),
        ),
        actions: [
          TextButton(
            onPressed: _isLoading ? null : _saveChanges,
            child: Text(
              'Ï†ÄÏû•',
              style: TextStyle(
                color: Colors.white,
                fontWeight: FontWeight.w600,
                fontSize: 16.sp,
              ),
            ),
          ),
        ],
      ),
      body: _isLoading
          ? const Center(child: CircularProgressIndicator())
          : SingleChildScrollView(
              padding: EdgeInsets.all(16.w),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  _buildAppInfoSection(),
                  SizedBox(height: 24.h),
                  _buildStatusSection(),
                  SizedBox(height: 24.h),
                  _buildAnnouncementSection(),
                  SizedBox(height: 24.h),
                  _buildPricingSection(),
                  SizedBox(height: 24.h),
                  _buildRequirementsSection(),
                  SizedBox(height: 32.h),
                ],
              ),
            ),
    );
  }

  Widget _buildStatusSection() {
    return Card(
      elevation: 2,
      child: Padding(
        padding: EdgeInsets.all(16.w),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Text(
                  'üéØ Ïï± Í≤åÏãú ÏÉÅÌÉú',
                  style: TextStyle(
                    fontSize: 18.sp,
                    fontWeight: FontWeight.bold,
                    color: Colors.indigo[900],
                  ),
                ),
                const Spacer(),
                Switch(
                  value: _isActive,
                  onChanged: (value) {
                    setState(() {
                      _isActive = value;
                    });
                  },
                  activeColor: Colors.green[700],
                ),
              ],
            ),
            SizedBox(height: 8.h),
            Text(
              _isActive
                  ? 'ÌòÑÏû¨ Ïï±Ïù¥ ÌôúÏÑ±ÌôîÎêòÏñ¥ ÌÖåÏä§ÌÑ∞Îì§ÏóêÍ≤å ÌëúÏãúÎê©ÎãàÎã§'
                  : 'ÌòÑÏû¨ Ïï±Ïù¥ ÎπÑÌôúÏÑ±ÌôîÎêòÏñ¥ ÌÖåÏä§ÌÑ∞Îì§ÏóêÍ≤å ÌëúÏãúÎêòÏßÄ ÏïäÏäµÎãàÎã§',
              style: TextStyle(
                fontSize: 14.sp,
                color: _isActive ? Colors.green[600] : Colors.red[600],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildAppInfoSection() {
    return Card(
      elevation: 2,
      child: Padding(
        padding: EdgeInsets.all(16.w),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'üì± Ïï± Í∏∞Î≥∏ Ï†ïÎ≥¥',
              style: TextStyle(
                fontSize: 18.sp,
                fontWeight: FontWeight.bold,
                color: Colors.indigo[900],
              ),
            ),
            SizedBox(height: 16.h),
            TextField(
              controller: _appNameController,
              decoration: InputDecoration(
                labelText: 'Ïï± Ïù¥Î¶Ñ *',
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8.r),
                ),
                prefixIcon: const Icon(Icons.apps),
              ),
            ),
            SizedBox(height: 16.h),
            TextField(
              controller: _appUrlController,
              decoration: InputDecoration(
                labelText: 'Ïï± URL',
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8.r),
                ),
                prefixIcon: const Icon(Icons.link),
              ),
            ),
            SizedBox(height: 16.h),
            DropdownButtonFormField<String>(
              value: _selectedCategory,
              decoration: InputDecoration(
                labelText: 'Ïπ¥ÌÖåÍ≥†Î¶¨',
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8.r),
                ),
                prefixIcon: const Icon(Icons.category),
              ),
              items: _categories.map((category) {
                return DropdownMenuItem(
                  value: category,
                  child: Text(category),
                );
              }).toList(),
              onChanged: (value) {
                setState(() {
                  _selectedCategory = value!;
                });
              },
            ),
            SizedBox(height: 16.h),
            TextField(
              controller: _descriptionController,
              maxLines: 3,
              decoration: InputDecoration(
                labelText: 'Ïï± ÏÑ§Î™Ö *',
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8.r),
                ),
                prefixIcon: const Icon(Icons.description),
                alignLabelWithHint: true,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildAnnouncementSection() {
    return Card(
      elevation: 2,
      child: Padding(
        padding: EdgeInsets.all(16.w),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Text(
                  'üì¢ Ïï± Í≥µÏßÄÏÇ¨Ìï≠',
                  style: TextStyle(
                    fontSize: 18.sp,
                    fontWeight: FontWeight.bold,
                    color: Colors.indigo[900],
                  ),
                ),
                const Spacer(),
                Switch(
                  value: _hasAnnouncement,
                  onChanged: (value) {
                    setState(() {
                      _hasAnnouncement = value;
                      if (!value) {
                        _announcementController.clear();
                      }
                    });
                  },
                  activeColor: Colors.indigo[700],
                ),
              ],
            ),
            SizedBox(height: 8.h),
            Text(
              _hasAnnouncement
                  ? 'ÌÖåÏä§ÌÑ∞Îì§ÏóêÍ≤å Î≥¥Ïó¨Ïßà Í≥µÏßÄÏÇ¨Ìï≠ÏùÑ ÏûëÏÑ±ÌïòÏÑ∏Ïöî'
                  : 'Í≥µÏßÄÏÇ¨Ìï≠ Í∏∞Îä•ÏùÑ ÌôúÏÑ±ÌôîÌïòÎ†§Î©¥ Ïä§ÏúÑÏπòÎ•º ÏºúÏÑ∏Ïöî',
              style: TextStyle(
                fontSize: 14.sp,
                color: Colors.grey[600],
              ),
            ),
            if (_hasAnnouncement) ...[
              SizedBox(height: 16.h),
              TextField(
                controller: _announcementController,
                maxLines: 4,
                decoration: InputDecoration(
                  labelText: 'Í≥µÏßÄÏÇ¨Ìï≠ ÎÇ¥Ïö©',
                  hintText: 'ÌÖåÏä§ÌÑ∞Îì§ÏóêÍ≤å Ï†ÑÎã¨Ìï† Ï§ëÏöîÌïú Ï†ïÎ≥¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî...',
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(8.r),
                  ),
                  prefixIcon: const Icon(Icons.announcement),
                  alignLabelWithHint: true,
                ),
              ),
            ],
          ],
        ),
      ),
    );
  }

  Widget _buildPricingSection() {
    return Card(
      elevation: 2,
      child: Padding(
        padding: EdgeInsets.all(16.w),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'üí∞ Îã®Í∞Ä ÏÑ§Ï†ï',
              style: TextStyle(
                fontSize: 18.sp,
                fontWeight: FontWeight.bold,
                color: Colors.indigo[900],
              ),
            ),
            SizedBox(height: 8.h),
            Text(
              'ÌÖåÏä§ÌÑ∞ÏóêÍ≤å ÏßÄÍ∏âÌï† Ìè¨Ïù∏Ìä∏Î•º ÏÑ§Ï†ïÌïòÏÑ∏Ïöî',
              style: TextStyle(
                fontSize: 14.sp,
                color: Colors.grey[600],
              ),
            ),
            SizedBox(height: 16.h),
            TextField(
              controller: _priceController,
              keyboardType: TextInputType.number,
              decoration: InputDecoration(
                labelText: 'Îã®Í∞Ä (Ìè¨Ïù∏Ìä∏) *',
                hintText: 'Ïòà: 1000',
                suffix: Text(
                  'P',
                  style: TextStyle(
                    fontSize: 16.sp,
                    fontWeight: FontWeight.bold,
                    color: Colors.indigo[700],
                  ),
                ),
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8.r),
                ),
                prefixIcon: const Icon(Icons.monetization_on),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildRequirementsSection() {
    return Card(
      elevation: 2,
      child: Padding(
        padding: EdgeInsets.all(16.w),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'üìã Í∏∞ÌÉÄ ÏöîÍµ¨ÏÇ¨Ìï≠',
              style: TextStyle(
                fontSize: 18.sp,
                fontWeight: FontWeight.bold,
                color: Colors.indigo[900],
              ),
            ),
            SizedBox(height: 8.h),
            Text(
              'ÌÖåÏä§ÌÑ∞Í∞Ä ÏïåÏïÑÏïº Ìï† Ï∂îÍ∞Ä ÏöîÍµ¨ÏÇ¨Ìï≠Ïù¥ÎÇò ÌäπÎ≥Ñ ÏßÄÏãúÏÇ¨Ìï≠ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî',
              style: TextStyle(
                fontSize: 14.sp,
                color: Colors.grey[600],
              ),
            ),
            SizedBox(height: 16.h),
            TextField(
              controller: _requirementsController,
              maxLines: 4,
              decoration: InputDecoration(
                labelText: 'ÏöîÍµ¨ÏÇ¨Ìï≠',
                hintText: 'Ïòà: ÌäπÏ†ï Í∏∞Í∏∞ÏóêÏÑú ÌÖåÏä§Ìä∏, ÌäπÏ†ï Í∏∞Îä• ÏßëÏ§ë ÌÖåÏä§Ìä∏ Îì±...',
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8.r),
                ),
                prefixIcon: const Icon(Icons.checklist),
                alignLabelWithHint: true,
              ),
            ),
          ],
        ),
      ),
    );
  }
}