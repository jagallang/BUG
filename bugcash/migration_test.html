<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BugCash ë§ˆì´ê·¸ë ˆì´ì…˜ ë„êµ¬</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background-color: #4285f4; color: white; }
        .btn-success { background-color: #34a853; color: white; }
        .btn-warning { background-color: #fbbc04; color: black; }
        .result { margin-top: 20px; padding: 10px; border-radius: 5px; white-space: pre-wrap; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; }
    </style>
    <script type="module">
        // Firebase 9.x modular SDK ì„¤ì •
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, updateDoc, writeBatch, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyA0hLevMSRKZpoMaF4Sb_YgvR7ED1VR6Xo",
            authDomain: "bugcash.firebaseapp.com",
            projectId: "bugcash",
            storageBucket: "bugcash.appspot.com",
            messagingSenderId: "335851774651",
            appId: "1:335851774651:web:f7efbf71fdfd36690abf9e"
        };

        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ê¸€ë¡œë²Œ í•¨ìˆ˜ë¡œ ë“±ë¡
        window.checkMigrationStatus = checkMigrationStatus;
        window.runMigration = runMigration;
        window.verifyMigration = verifyMigration;

        async function checkMigrationStatus() {
            showResult('ğŸ” ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ í™•ì¸ ì¤‘...', 'info');

            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));

                let newFormat = 0;
                let oldFormat = 0;
                const roleStats = {};
                const samples = [];

                usersSnapshot.forEach(doc => {
                    const data = doc.data();

                    if (data.roles && data.primaryRole) {
                        newFormat++;
                        const roles = data.roles || [];
                        roles.forEach(role => {
                            roleStats[role] = (roleStats[role] || 0) + 1;
                        });
                    } else {
                        oldFormat++;
                        if (samples.length < 3) {
                            samples.push({
                                id: doc.id,
                                email: data.email,
                                userType: data.userType
                            });
                        }
                    }
                });

                const result = `ğŸ“Š ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ:
ì´ ì‚¬ìš©ì: ${usersSnapshot.size}ëª…
âœ… ìƒˆ í˜•ì‹: ${newFormat}ëª…
âŒ ê¸°ì¡´ í˜•ì‹: ${oldFormat}ëª…
ì™„ë£Œìœ¨: ${((newFormat / usersSnapshot.size) * 100).toFixed(1)}%

ğŸ‘¥ ì—­í• ë³„ í†µê³„:
${Object.entries(roleStats).map(([role, count]) => `  ${role}: ${count}ëª…`).join('\n')}

ğŸ” ê¸°ì¡´ í˜•ì‹ ìƒ˜í”Œ:
${samples.map(s => `  ${s.id} (${s.email}) - ${s.userType}`).join('\n')}`;

                showResult(result, 'info');

            } catch (error) {
                showResult(`âŒ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        async function runMigration() {
            if (!confirm('ğŸš¨ ì‚¬ìš©ì ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ëª¨ë“  ì‚¬ìš©ì ë°ì´í„°ë¥¼ ìƒˆë¡œìš´ ë‹¤ì¤‘ ì—­í•  ì‹œìŠ¤í…œìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.')) {
                return;
            }

            showResult('ğŸ”„ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ì¤‘... (ìµœëŒ€ 5ë¶„ ì†Œìš”)', 'info');

            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));

                let migratedCount = 0;
                let skippedCount = 0;
                const errors = [];

                // ë°°ì¹˜ ì‘ì—… (500ê°œì”© ì²˜ë¦¬)
                const batches = [];
                let currentBatch = writeBatch(db);
                let operationCount = 0;

                usersSnapshot.forEach(userDoc => {
                    try {
                        const data = userDoc.data();
                        const userId = userDoc.id;

                        // ì´ë¯¸ ë§ˆì´ê·¸ë ˆì´ì…˜ëœ ì‚¬ìš©ìëŠ” ê±´ë„ˆë›°ê¸°
                        if (data.roles && data.primaryRole) {
                            skippedCount++;
                            return;
                        }

                        const oldUserType = data.userType || 'tester';
                        const updateData = {
                            roles: [oldUserType],
                            primaryRole: oldUserType,
                            isAdmin: oldUserType === 'admin',
                            migratedAt: serverTimestamp(),
                            migratedBy: 'web-migration-tool'
                        };

                        // ì—­í• ë³„ í”„ë¡œí•„ ì¶”ê°€
                        if (oldUserType === 'tester') {
                            updateData.testerProfile = {
                                preferredCategories: data.preferredCategories || [],
                                devices: data.devices || [],
                                experience: data.experience || null,
                                rating: data.rating || 0.0,
                                completedTests: data.completedMissions || 0,
                                testingPreferences: data.testingPreferences || {},
                                verificationStatus: data.verificationStatus || 'pending'
                            };
                        } else if (oldUserType === 'provider') {
                            updateData.providerProfile = {
                                companyName: data.companyName || null,
                                website: data.website || null,
                                businessType: data.businessType || null,
                                appCategories: data.appCategories || [],
                                contactInfo: data.contactInfo || null,
                                rating: data.rating || 0.0,
                                publishedApps: data.publishedApps || 0,
                                businessInfo: data.businessInfo || {},
                                verificationStatus: data.verificationStatus || 'pending'
                            };
                        }

                        const userRef = doc(db, 'users', userId);
                        currentBatch.update(userRef, updateData);
                        operationCount++;
                        migratedCount++;

                        // ë°°ì¹˜ í¬ê¸° ì œí•œ í™•ì¸
                        if (operationCount >= 500) {
                            batches.push(currentBatch);
                            currentBatch = writeBatch(db);
                            operationCount = 0;
                        }

                    } catch (error) {
                        errors.push(`${userDoc.id}: ${error.message}`);
                    }
                });

                // ë§ˆì§€ë§‰ ë°°ì¹˜ ì¶”ê°€
                if (operationCount > 0) {
                    batches.push(currentBatch);
                }

                // ëª¨ë“  ë°°ì¹˜ ì»¤ë°‹
                for (let i = 0; i < batches.length; i++) {
                    await batches[i].commit();
                    showResult(`ğŸ“¦ ë°°ì¹˜ ${i + 1}/${batches.length} ì»¤ë°‹ ì™„ë£Œ`, 'info');
                }

                const result = `ğŸ‰ ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ!

ğŸ“Š ê²°ê³¼:
  ì´ ì‚¬ìš©ì: ${usersSnapshot.size}ëª…
  âœ… ë§ˆì´ê·¸ë ˆì´ì…˜: ${migratedCount}ëª…
  â­ï¸ ê±´ë„ˆë›°ê¸°: ${skippedCount}ëª…
  âŒ ì‹¤íŒ¨: ${errors.length}ëª…

${errors.length > 0 ? `\nğŸš¨ ì‹¤íŒ¨í•œ í•­ëª©ë“¤:\n${errors.slice(0, 10).join('\n')}` : ''}`;

                showResult(result, 'success');

                // ìë™ìœ¼ë¡œ ê²€ì¦ ì‹¤í–‰
                setTimeout(() => verifyMigration(), 2000);

            } catch (error) {
                showResult(`âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        async function verifyMigration() {
            showResult('ğŸ” ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦ ì¤‘...', 'info');

            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const validationErrors = [];

                usersSnapshot.forEach(userDoc => {
                    const data = userDoc.data();
                    const userId = userDoc.id;

                    // ìƒˆ í˜•ì‹ ê²€ì¦
                    if (data.roles && data.primaryRole) {
                        // í•„ìˆ˜ í•„ë“œ í™•ì¸
                        if (!Array.isArray(data.roles) || data.roles.length === 0) {
                            validationErrors.push(`${userId}: Invalid roles array`);
                        }

                        if (!data.roles.includes(data.primaryRole)) {
                            validationErrors.push(`${userId}: primaryRole not in roles array`);
                        }

                        // ì—­í• ë³„ í”„ë¡œí•„ í™•ì¸
                        if (data.primaryRole === 'tester' && !data.testerProfile) {
                            validationErrors.push(`${userId}: Missing testerProfile`);
                        }

                        if (data.primaryRole === 'provider' && !data.providerProfile) {
                            validationErrors.push(`${userId}: Missing providerProfile`);
                        }
                    } else {
                        validationErrors.push(`${userId}: Still in old format`);
                    }
                });

                const result = `âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦ ì™„ë£Œ!

ğŸ“Š ê²€ì¦ ê²°ê³¼:
  ì´ ì‚¬ìš©ì: ${usersSnapshot.size}ëª…
  ê²€ì¦ ì˜¤ë¥˜: ${validationErrors.length}ê°œ
  ì„±ê³µë¥ : ${(((usersSnapshot.size - validationErrors.length) / usersSnapshot.size) * 100).toFixed(1)}%

${validationErrors.length > 0 ? `\nâš ï¸ ê²€ì¦ ì˜¤ë¥˜ë“¤:\n${validationErrors.slice(0, 10).join('\n')}` : '\nğŸ‰ ëª¨ë“  ì‚¬ìš©ìê°€ ì˜¬ë°”ë¥´ê²Œ ë§ˆì´ê·¸ë ˆì´ì…˜ë˜ì—ˆìŠµë‹ˆë‹¤!'}`;

                showResult(result, validationErrors.length === 0 ? 'success' : 'error');

            } catch (error) {
                showResult(`âŒ ê²€ì¦ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        function showResult(text, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = text;
            resultDiv.className = `result ${type}`;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ìƒíƒœ í™•ì¸
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => checkMigrationStatus(), 1000);
        });
    </script>
</head>
<body>
    <h1>ğŸš€ BugCash ì‚¬ìš©ì ë§ˆì´ê·¸ë ˆì´ì…˜ ë„êµ¬</h1>

    <div>
        <h2>ğŸ“‹ ë§ˆì´ê·¸ë ˆì´ì…˜ ê³¼ì •</h2>
        <p>ì´ ë„êµ¬ëŠ” ê¸°ì¡´ ì‚¬ìš©ì ë°ì´í„°ë¥¼ ìƒˆë¡œìš´ ë‹¤ì¤‘ ì—­í•  ì‹œìŠ¤í…œìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•©ë‹ˆë‹¤:</p>
        <ul>
            <li><strong>userType</strong> â†’ <strong>roles</strong> ë°°ì—´ + <strong>primaryRole</strong></li>
            <li>ì—­í• ë³„ í”„ë¡œí•„ ìƒì„± (testerProfile, providerProfile)</li>
            <li>ê´€ë¦¬ì ê¶Œí•œ ì„¤ì • (isAdmin)</li>
        </ul>
    </div>

    <div>
        <h2>ğŸ”§ ë„êµ¬</h2>
        <button class="btn btn-primary" onclick="checkMigrationStatus()">ğŸ“Š ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ í™•ì¸</button>
        <button class="btn btn-warning" onclick="runMigration()">ğŸ”„ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰</button>
        <button class="btn btn-success" onclick="verifyMigration()">âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦</button>
    </div>

    <div id="result" class="result info">
        ğŸ”„ Firebase ì—°ê²° ì¤‘...
    </div>

    <div style="margin-top: 30px; padding: 15px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">
        <h3>âš ï¸ ì£¼ì˜ì‚¬í•­</h3>
        <ul>
            <li>ë§ˆì´ê·¸ë ˆì´ì…˜ì€ <strong>ë˜ëŒë¦´ ìˆ˜ ì—†ëŠ”</strong> ì‘ì—…ì…ë‹ˆë‹¤</li>
            <li>ì‹¤í–‰ ì „ì— ë°˜ë“œì‹œ <strong>ë°ì´í„° ë°±ì—…</strong>ì„ í™•ì¸í•˜ì„¸ìš”</li>
            <li>ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘ì—ëŠ” ì•± ì‚¬ìš©ì„ ì¤‘ë‹¨í•´ì£¼ì„¸ìš”</li>
            <li>ìµœëŒ€ 5ë¶„ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
        </ul>
    </div>
</body>
</html>