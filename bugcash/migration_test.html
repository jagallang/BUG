<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BugCash 마이그레이션 도구</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background-color: #4285f4; color: white; }
        .btn-success { background-color: #34a853; color: white; }
        .btn-warning { background-color: #fbbc04; color: black; }
        .result { margin-top: 20px; padding: 10px; border-radius: 5px; white-space: pre-wrap; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; }
    </style>
    <script type="module">
        // Firebase 9.x modular SDK 설정
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, updateDoc, writeBatch, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyA0hLevMSRKZpoMaF4Sb_YgvR7ED1VR6Xo",
            authDomain: "bugcash.firebaseapp.com",
            projectId: "bugcash",
            storageBucket: "bugcash.appspot.com",
            messagingSenderId: "335851774651",
            appId: "1:335851774651:web:f7efbf71fdfd36690abf9e"
        };

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 글로벌 함수로 등록
        window.checkMigrationStatus = checkMigrationStatus;
        window.runMigration = runMigration;
        window.verifyMigration = verifyMigration;

        async function checkMigrationStatus() {
            showResult('🔍 마이그레이션 상태 확인 중...', 'info');

            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));

                let newFormat = 0;
                let oldFormat = 0;
                const roleStats = {};
                const samples = [];

                usersSnapshot.forEach(doc => {
                    const data = doc.data();

                    if (data.roles && data.primaryRole) {
                        newFormat++;
                        const roles = data.roles || [];
                        roles.forEach(role => {
                            roleStats[role] = (roleStats[role] || 0) + 1;
                        });
                    } else {
                        oldFormat++;
                        if (samples.length < 3) {
                            samples.push({
                                id: doc.id,
                                email: data.email,
                                userType: data.userType
                            });
                        }
                    }
                });

                const result = `📊 마이그레이션 상태:
총 사용자: ${usersSnapshot.size}명
✅ 새 형식: ${newFormat}명
❌ 기존 형식: ${oldFormat}명
완료율: ${((newFormat / usersSnapshot.size) * 100).toFixed(1)}%

👥 역할별 통계:
${Object.entries(roleStats).map(([role, count]) => `  ${role}: ${count}명`).join('\n')}

🔍 기존 형식 샘플:
${samples.map(s => `  ${s.id} (${s.email}) - ${s.userType}`).join('\n')}`;

                showResult(result, 'info');

            } catch (error) {
                showResult(`❌ 상태 확인 실패: ${error.message}`, 'error');
            }
        }

        async function runMigration() {
            if (!confirm('🚨 사용자 데이터 마이그레이션을 실행하시겠습니까?\n\n이 작업은 모든 사용자 데이터를 새로운 다중 역할 시스템으로 변환합니다.')) {
                return;
            }

            showResult('🔄 마이그레이션 실행 중... (최대 5분 소요)', 'info');

            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));

                let migratedCount = 0;
                let skippedCount = 0;
                const errors = [];

                // 배치 작업 (500개씩 처리)
                const batches = [];
                let currentBatch = writeBatch(db);
                let operationCount = 0;

                usersSnapshot.forEach(userDoc => {
                    try {
                        const data = userDoc.data();
                        const userId = userDoc.id;

                        // 이미 마이그레이션된 사용자는 건너뛰기
                        if (data.roles && data.primaryRole) {
                            skippedCount++;
                            return;
                        }

                        const oldUserType = data.userType || 'tester';
                        const updateData = {
                            roles: [oldUserType],
                            primaryRole: oldUserType,
                            isAdmin: oldUserType === 'admin',
                            migratedAt: serverTimestamp(),
                            migratedBy: 'web-migration-tool'
                        };

                        // 역할별 프로필 추가
                        if (oldUserType === 'tester') {
                            updateData.testerProfile = {
                                preferredCategories: data.preferredCategories || [],
                                devices: data.devices || [],
                                experience: data.experience || null,
                                rating: data.rating || 0.0,
                                completedTests: data.completedMissions || 0,
                                testingPreferences: data.testingPreferences || {},
                                verificationStatus: data.verificationStatus || 'pending'
                            };
                        } else if (oldUserType === 'provider') {
                            updateData.providerProfile = {
                                companyName: data.companyName || null,
                                website: data.website || null,
                                businessType: data.businessType || null,
                                appCategories: data.appCategories || [],
                                contactInfo: data.contactInfo || null,
                                rating: data.rating || 0.0,
                                publishedApps: data.publishedApps || 0,
                                businessInfo: data.businessInfo || {},
                                verificationStatus: data.verificationStatus || 'pending'
                            };
                        }

                        const userRef = doc(db, 'users', userId);
                        currentBatch.update(userRef, updateData);
                        operationCount++;
                        migratedCount++;

                        // 배치 크기 제한 확인
                        if (operationCount >= 500) {
                            batches.push(currentBatch);
                            currentBatch = writeBatch(db);
                            operationCount = 0;
                        }

                    } catch (error) {
                        errors.push(`${userDoc.id}: ${error.message}`);
                    }
                });

                // 마지막 배치 추가
                if (operationCount > 0) {
                    batches.push(currentBatch);
                }

                // 모든 배치 커밋
                for (let i = 0; i < batches.length; i++) {
                    await batches[i].commit();
                    showResult(`📦 배치 ${i + 1}/${batches.length} 커밋 완료`, 'info');
                }

                const result = `🎉 마이그레이션 완료!

📊 결과:
  총 사용자: ${usersSnapshot.size}명
  ✅ 마이그레이션: ${migratedCount}명
  ⏭️ 건너뛰기: ${skippedCount}명
  ❌ 실패: ${errors.length}명

${errors.length > 0 ? `\n🚨 실패한 항목들:\n${errors.slice(0, 10).join('\n')}` : ''}`;

                showResult(result, 'success');

                // 자동으로 검증 실행
                setTimeout(() => verifyMigration(), 2000);

            } catch (error) {
                showResult(`❌ 마이그레이션 실패: ${error.message}`, 'error');
            }
        }

        async function verifyMigration() {
            showResult('🔍 마이그레이션 검증 중...', 'info');

            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const validationErrors = [];

                usersSnapshot.forEach(userDoc => {
                    const data = userDoc.data();
                    const userId = userDoc.id;

                    // 새 형식 검증
                    if (data.roles && data.primaryRole) {
                        // 필수 필드 확인
                        if (!Array.isArray(data.roles) || data.roles.length === 0) {
                            validationErrors.push(`${userId}: Invalid roles array`);
                        }

                        if (!data.roles.includes(data.primaryRole)) {
                            validationErrors.push(`${userId}: primaryRole not in roles array`);
                        }

                        // 역할별 프로필 확인
                        if (data.primaryRole === 'tester' && !data.testerProfile) {
                            validationErrors.push(`${userId}: Missing testerProfile`);
                        }

                        if (data.primaryRole === 'provider' && !data.providerProfile) {
                            validationErrors.push(`${userId}: Missing providerProfile`);
                        }
                    } else {
                        validationErrors.push(`${userId}: Still in old format`);
                    }
                });

                const result = `✅ 마이그레이션 검증 완료!

📊 검증 결과:
  총 사용자: ${usersSnapshot.size}명
  검증 오류: ${validationErrors.length}개
  성공률: ${(((usersSnapshot.size - validationErrors.length) / usersSnapshot.size) * 100).toFixed(1)}%

${validationErrors.length > 0 ? `\n⚠️ 검증 오류들:\n${validationErrors.slice(0, 10).join('\n')}` : '\n🎉 모든 사용자가 올바르게 마이그레이션되었습니다!'}`;

                showResult(result, validationErrors.length === 0 ? 'success' : 'error');

            } catch (error) {
                showResult(`❌ 검증 실패: ${error.message}`, 'error');
            }
        }

        function showResult(text, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = text;
            resultDiv.className = `result ${type}`;
        }

        // 페이지 로드 시 자동으로 상태 확인
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => checkMigrationStatus(), 1000);
        });
    </script>
</head>
<body>
    <h1>🚀 BugCash 사용자 마이그레이션 도구</h1>

    <div>
        <h2>📋 마이그레이션 과정</h2>
        <p>이 도구는 기존 사용자 데이터를 새로운 다중 역할 시스템으로 마이그레이션합니다:</p>
        <ul>
            <li><strong>userType</strong> → <strong>roles</strong> 배열 + <strong>primaryRole</strong></li>
            <li>역할별 프로필 생성 (testerProfile, providerProfile)</li>
            <li>관리자 권한 설정 (isAdmin)</li>
        </ul>
    </div>

    <div>
        <h2>🔧 도구</h2>
        <button class="btn btn-primary" onclick="checkMigrationStatus()">📊 마이그레이션 상태 확인</button>
        <button class="btn btn-warning" onclick="runMigration()">🔄 마이그레이션 실행</button>
        <button class="btn btn-success" onclick="verifyMigration()">✅ 마이그레이션 검증</button>
    </div>

    <div id="result" class="result info">
        🔄 Firebase 연결 중...
    </div>

    <div style="margin-top: 30px; padding: 15px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">
        <h3>⚠️ 주의사항</h3>
        <ul>
            <li>마이그레이션은 <strong>되돌릴 수 없는</strong> 작업입니다</li>
            <li>실행 전에 반드시 <strong>데이터 백업</strong>을 확인하세요</li>
            <li>마이그레이션 중에는 앱 사용을 중단해주세요</li>
            <li>최대 5분 정도 소요될 수 있습니다</li>
        </ul>
    </div>
</body>
</html>