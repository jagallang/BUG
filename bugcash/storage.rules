rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // 사용자 프로필 이미지
    match /users/{userId}/profile/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId
                   && request.resource.size < 5 * 1024 * 1024  // 5MB 제한
                   && request.resource.contentType.matches('image/.*');
    }

    // 버그 리포트 스크린샷 및 첨부파일
    match /bug_reports/{reportId}/{allPaths=**} {
      allow read: if request.auth != null;
      allow create: if request.auth != null
                    && request.resource.size < 10 * 1024 * 1024  // 10MB 제한
                    && (request.resource.contentType.matches('image/.*') ||
                        request.resource.contentType.matches('video/.*'));
      allow update, delete: if request.auth != null
                            && request.auth.uid == resource.metadata['uploadedBy'];
    }

    // 앱 아이콘 및 공개 리소스
    match /apps/{appId}/public/{allPaths=**} {
      allow read: if true;  // 앱 아이콘은 공개
      allow write: if request.auth != null
                   && request.auth.token.role == 'developer'  // 개발자만 업로드
                   && request.resource.size < 2 * 1024 * 1024;  // 2MB 제한
    }

    // 미션 관련 파일
    match /missions/{missionId}/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null
                   && request.auth.token.role in ['developer', 'admin'];
    }

    // 기타 모든 경로는 차단
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
